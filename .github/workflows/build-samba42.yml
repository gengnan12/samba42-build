name: Build Samba for ARMv7 (Standard Build)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cross-compilation tools
        run: |
          echo "===== å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            pkg-config \
            curl \
            python3 \
            python3-pip

      - name: Download Samba source
        run: |
          echo "===== ä¸‹è½½Sambaæºç  ====="
          # ä½¿ç”¨è¾ƒæ–°çš„Sambaç‰ˆæœ¬ï¼Œä½†ä¸è¦å¤ªæ–°ä»¥é¿å…å…¼å®¹æ€§é—®é¢˜
          SAMBA_VERSION="4.13.0"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz

      - name: Build with standard configure and make
        run: |
          echo "===== ä½¿ç”¨æ ‡å‡†æž„å»ºç³»ç»Ÿç¼–è¯‘ ====="
          cd samba-4.13.0
          
          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export AR="arm-linux-gnueabihf-ar"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"
          
          # é…ç½®Samba
          ./configure \
            --host=arm-linux-gnueabihf \
            --target=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --disable-avahi \
            --disable-cups \
            --disable-iprint \
            --disable-glusterfs \
            --disable-json \
            --disable-libarchive \
            --with-shared-modules=!pdb_tdbsam,pdb_smbpasswd,pdb_wbc_sam,idmap_nss,nss_info_template,auth_unix,auth_wbc,auth_sam,auth_script,auth_netlogond
          
          # ç¼–è¯‘ç‰¹å®šçš„ç›®æ ‡
          make -j$(nproc) all

      - name: Try to build only specific binaries
        if: failure()
        run: |
          echo "===== å°è¯•åªç¼–è¯‘ç‰¹å®šäºŒè¿›åˆ¶æ–‡ä»¶ ====="
          cd samba-4.13.0
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"
          
          # å°è¯•ç›´æŽ¥ç¼–è¯‘æ ¸å¿ƒç»„ä»¶
          make -j$(nproc) \
            CC="${CC}" \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            smbd/smbd nmbd/nmbd client/smbpasswd

      - name: Check for compiled binaries
        run: |
          echo "===== æ£€æŸ¥ç¼–è¯‘ç»“æžœ ====="
          cd samba-4.13.0
          
          # æŸ¥æ‰¾ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
          find . -name "smbd" -type f -executable | head -5
          find . -name "nmbd" -type f -executable | head -5
          find . -name "smbpasswd" -type f -executable | head -5
          
          # æ£€æŸ¥binç›®å½•
          if [ -d "bin" ]; then
            ls -la bin/
            mkdir -p ../samba-deploy
            cp bin/smbd bin/nmbd bin/smbpasswd ../samba-deploy/ 2>/dev/null || true
          fi
          
          # æ£€æŸ¥å…¶ä»–å¯èƒ½çš„ä½ç½®
          if [ -f "bin/default/source3/smbd/smbd" ]; then
            mkdir -p ../samba-deploy
            cp bin/default/source3/smbd/smbd ../samba-deploy/smbd
            cp bin/default/source3/nmbd/nmbd ../samba-deploy/nmbd
            cp bin/default/source3/utils/smbpasswd ../samba-deploy/smbpasswd
          fi

      - name: Create deployment package
        run: |
          echo "===== åˆ›å»ºéƒ¨ç½²åŒ… ====="
          mkdir -p samba-deploy
          
          # å¦‚æžœæ‰¾åˆ°äº†äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¤åˆ¶å®ƒä»¬
          if [ -f "samba-4.13.0/bin/smbd" ]; then
            cp samba-4.13.0/bin/smbd samba-4.13.0/bin/nmbd samba-4.13.0/bin/smbpasswd samba-deploy/
          elif [ -f "samba-4.13.0/bin/default/source3/smbd/smbd" ]; then
            cp samba-4.13.0/bin/default/source3/smbd/smbd samba-deploy/smbd
            cp samba-4.13.0/bin/default/source3/nmbd/nmbd samba-deploy/nmbd
            cp samba-4.13.0/bin/default/source3/utils/smbpasswd samba-deploy/smbpasswd
          else
            echo "æœªæ‰¾åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåˆ›å»ºè¯´æ˜Žæ–‡æ¡£"
            # åˆ›å»ºè¯´æ˜Žæ–‡æ¡£
            cat > samba-deploy/README.md << 'EOF'
            # Samba for ARMv7 ç¼–è¯‘è¯´æ˜Ž
            
            è‡ªåŠ¨ç¼–è¯‘è¿‡ç¨‹æœªèƒ½æˆåŠŸç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¯·å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š
            
            ## æ–¹æ³•ä¸€: åœ¨ç›®æ ‡è®¾å¤‡ä¸Šç›´æŽ¥ç¼–è¯‘
            1. åœ¨æ‚¨çš„ARMè®¾å¤‡ä¸Šä¸‹è½½Sambaæºç :
               wget https://download.samba.org/pub/samba/stable/samba-4.13.0.tar.gz
            2. è§£åŽ‹æºç :
               tar -xzf samba-4.13.0.tar.gz
            3. è¿›å…¥æºç ç›®å½•:
               cd samba-4.13.0
            4. é…ç½®å’Œç¼–è¯‘:
               ./configure --prefix=/usr --disable-python --without-ad-dc
               make -j$(nproc) smbd nmbd smbpasswd
            5. å®‰è£…:
               sudo make install
            
            ## æ–¹æ³•äºŒ: ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…
            å¦‚æžœæ‚¨çš„ç³»ç»Ÿæœ‰åŒ…ç®¡ç†å™¨ï¼Œå¯ä»¥å°è¯•:
            - Debian/Ubuntu: sudo apt-get install samba
            - OpenWrt: opkg install samba4-server
            - CentOS/RHEL: sudo yum install samba
            
            ## æ–¹æ³•ä¸‰: å¯»æ‰¾é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶
            æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®å¯»æ‰¾é¢„ç¼–è¯‘çš„ARMv7 SambaäºŒè¿›åˆ¶æ–‡ä»¶:
            - æ‚¨çš„Linuxå‘è¡Œç‰ˆä»“åº“
            - ç¬¬ä¸‰æ–¹ARMè½¯ä»¶æº
            - å¼€æºé¡¹ç›®å¦‚OpenWrtæˆ–Buildrootçš„é¢„ç¼–è¯‘åŒ…
            EOF
          fi
          
          # åˆ›å»ºå®‰è£…è„šæœ¬
          cd samba-deploy
          if [ -f "smbd" ]; then
            cat > install.sh << 'EOF'
            #!/bin/sh
            echo "å®‰è£…Samba for ARMv7..."
            
            # æ£€æŸ¥æƒé™
            if [ "$(id -u)" -ne 0 ]; then
              echo "è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬: sudo ./install.sh"
              exit 1
            fi
            
            # å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
            for bin in smbd nmbd smbpasswd; do
              if [ -f "$bin" ]; then
                install -m 755 "$bin" "/usr/sbin/"
                echo "å·²å®‰è£…: /usr/sbin/$bin"
              else
                echo "è­¦å‘Š: æ‰¾ä¸åˆ°æ–‡ä»¶ $bin"
              fi
            done
            
            echo "å®‰è£…å®Œæˆ!"
            echo ""
            echo "ä½¿ç”¨æ–¹æ³•:"
            echo "1. åˆ›å»ºé…ç½®æ–‡ä»¶: /etc/samba/smb.conf"
            echo "2. å¯åŠ¨æœåŠ¡: smbd -D && nmbd -D"
            echo "3. æ·»åŠ ç”¨æˆ·: smbpasswd -a username"
            EOF
            
            chmod +x install.sh
            
            # åˆ›å»ºç¤ºä¾‹é…ç½®æ–‡ä»¶
            cat > smb.conf.example << 'EOF'
            [global]
            workgroup = WORKGROUP
            netbios name = SAMBA_SERVER
            server string = Samba Server
            security = user
            map to guest = Bad User
            log file = /var/log/samba/log.%m
            max log size = 50

            [homes]
            comment = Home Directories
            browseable = no
            writable = yes
            valid users = %S

            [shared]
            comment = Shared Folder
            path = /mnt/shared
            browseable = yes
            writable = yes
            guest ok = no
            create mask = 0644
            directory mask = 0755
            EOF
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba-armv7
          path: samba-deploy/*
          retention-days: 30

      - name: Show final message
        run: |
          echo "æž„å»ºè¿‡ç¨‹å®Œæˆ!"
          if [ -f "samba-deploy/smbd" ]; then
            echo "âœ… æˆåŠŸç¼–è¯‘äº†SambaäºŒè¿›åˆ¶æ–‡ä»¶"
            echo "ðŸ“¦ æ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          else
            echo "âš ï¸ æœªèƒ½ç¼–è¯‘SambaäºŒè¿›åˆ¶æ–‡ä»¶"
            echo "ðŸ“‹ å·²ä¸Šä¼ è¯´æ˜Žæ–‡æ¡£ï¼Œè¯·æŸ¥çœ‹å…¶ä»–å®‰è£…é€‰é¡¹"
          fi
          echo "ðŸ–¥ï¸  ç›®æ ‡æž¶æž„: ARMv7"
          echo "â° å®Œæˆæ—¶é—´: $(date)"
