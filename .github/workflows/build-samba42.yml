name: Build Samba 4 for ARMv7 (Docker Approach)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker build environment
        run: |
          echo "===== è®¾ç½®Dockerç¼–è¯‘çŽ¯å¢ƒ ====="
          sudo apt update
          sudo apt install -y docker.io

      - name: Create Dockerfile for cross compilation
        run: |
          echo "===== åˆ›å»ºDockerfile ====="
          cat > Dockerfile << 'EOF'
          FROM ubuntu:20.04

          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=UTC

          # å®‰è£…ç¼–è¯‘å·¥å…·å’Œä¾èµ–
          RUN apt update && apt install -y \
              build-essential \
              gcc-arm-linux-gnueabihf \
              g++-arm-linux-gnueabihf \
              wget tar xz-utils make \
              python2 \
              python2-dev \
              pkg-config \
              curl

          # è®¾ç½®å·¥ä½œç›®å½•
          WORKDIR /build

          # å¤åˆ¶ç¼–è¯‘è„šæœ¬
          COPY build-samba.sh .

          # è®¾ç½®æ‰§è¡Œæƒé™
          RUN chmod +x build-samba.sh

          # è®¾ç½®å…¥å£ç‚¹
          CMD ["./build-samba.sh"]
          EOF

      - name: Create build script
        run: |
          echo "===== åˆ›å»ºç¼–è¯‘è„šæœ¬ ====="
          cat > build-samba.sh << 'EOF'
          #!/bin/bash

          set -e

          echo "===== å¼€å§‹ç¼–è¯‘Samba for ARMv7 ====="

          # è®¾ç½®Python 2ä¸ºé»˜è®¤
          update-alternatives --install /usr/bin/python python /usr/bin/python2 1
          update-alternatives --install /usr/bin/python python /usr/bin/python3 2
          update-alternatives --set python /usr/bin/python2
          python --version

          # ç¼–è¯‘zlib
          echo "===== ç¼–è¯‘zlib ====="
          wget https://zlib.net/zlib-1.2.13.tar.gz -O zlib-1.2.13.tar.gz
          tar -xzf zlib-1.2.13.tar.gz
          cd zlib-1.2.13
          CC="arm-linux-gnueabihf-gcc" \
          CFLAGS="-march=armv7-a -mfpu=neon -Os" \
          ./configure --prefix=/opt/arm-deps --static
          make -j$(nproc)
          make install
          cd ..

          # ç¼–è¯‘OpenSSL
          echo "===== ç¼–è¯‘OpenSSL ====="
          wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz -O openssl-1.1.1w.tar.gz
          tar -xzf openssl-1.1.1w.tar.gz
          cd openssl-1.1.1w
          export CROSS_COMPILE="arm-linux-gnueabihf-"
          export CC="${CROSS_COMPILE}gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          ./Configure linux-armv4 \
            --prefix=/opt/arm-deps \
            no-shared \
            no-dso \
            no-asm \
            ${CFLAGS}
          sed -i 's/^CC=.*/CC=$(CROSS_COMPILE)gcc/' Makefile
          make -j$(nproc)
          make install
          cd ..

          # ä¸‹è½½å’Œç¼–è¯‘Samba 4.8.12
          echo "===== ç¼–è¯‘Samba 4.8.12 ====="
          wget https://download.samba.org/pub/samba/stable/samba-4.8.12.tar.gz -O samba-4.8.12.tar.gz
          tar -xzf samba-4.8.12.tar.gz
          cd samba-4.8.12

          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static -lssl -lcrypto -lz"

          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --with-zlib=/opt/arm-deps \
            --enable-static \
            --disable-shared \
            --without-gnutls

          make -j$(nproc) all

          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
          mkdir -p /output
          cp bin/smbd bin/nmbd bin/smbpasswd /output/

          echo "===== ç¼–è¯‘å®Œæˆ ====="
          EOF

          chmod +x build-samba.sh

      - name: Build using Docker
        run: |
          echo "===== ä½¿ç”¨Dockerç¼–è¯‘ ====="
          # æž„å»ºDockeré•œåƒ
          sudo docker build -t samba-builder .
          
          # è¿è¡ŒDockerå®¹å™¨å¹¶ç¼–è¯‘
          sudo docker run --rm -v $(pwd)/output:/output samba-builder
          
          # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
          ls -la output/

      - name: Alternative direct compilation
        if: failure()
        run: |
          echo "===== ç›´æŽ¥ç¼–è¯‘æ–¹æ¡ˆ ====="
          # å¦‚æžœDockeræ–¹æ¡ˆå¤±è´¥ï¼Œå°è¯•ç›´æŽ¥ç¼–è¯‘
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            pkg-config \
            curl

          # ä¸‹è½½Samba 4.13+ (æ”¯æŒPython 3)
          wget https://download.samba.org/pub/samba/stable/samba-4.13.0.tar.gz
          tar -xzf samba-4.13.0.tar.gz
          cd samba-4.13.0

          # ç›´æŽ¥ç¼–è¯‘æ ¸å¿ƒç»„ä»¶ï¼Œè·³è¿‡å¤æ‚çš„é…ç½®
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"

          cd source3
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --enable-static \
            --disable-shared

          make -j$(nproc) smbd nmbd smbpasswd

          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          mkdir -p ../output
          cp bin/smbd bin/nmbd bin/smbpasswd ../output/

      - name: Collect binaries
        run: |
          echo "===== æ”¶é›†äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          mkdir -p samba-deploy
          
          # ä»ŽDockerè¾“å‡ºæˆ–ç›´æŽ¥ç¼–è¯‘è¾“å‡ºå¤åˆ¶æ–‡ä»¶
          if [ -d "output" ] && [ "$(ls -A output)" ]; then
            cp output/* samba-deploy/
          elif [ -f "samba-4.13.0/source3/bin/smbd" ]; then
            cp samba-4.13.0/source3/bin/smbd samba-4.13.0/source3/bin/nmbd samba-4.13.0/source3/bin/smbpasswd samba-deploy/
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi

          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          cd samba-deploy
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file smbd
          echo "æž¶æž„æ£€æŸ¥:"
          arm-linux-gnueabihf-readelf -h smbd | grep "Machine:" | grep "ARM" || exit 1

      - name: Create installation package
        run: |
          echo "===== åˆ›å»ºå®‰è£…åŒ… ====="
          cd samba-deploy
          
          cat > install.sh << 'EOF'
          #!/bin/sh
          echo "å®‰è£…Samba for ARMv7..."
          echo "ç³»ç»Ÿæž¶æž„: $(uname -m)"
          
          # å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
          for bin in smbd nmbd smbpasswd; do
            if [ -f "/usr/sbin/$bin" ]; then
              mv "/usr/sbin/$bin" "/usr/sbin/${bin}.backup"
              echo "å·²å¤‡ä»½: /usr/sbin/${bin}.backup"
            fi
            install -m 755 "$bin" "/usr/sbin/"
            echo "å·²å®‰è£…: /usr/sbin/$bin"
          done
          
          echo "å®‰è£…å®Œæˆ!"
          echo ""
          echo "ä½¿ç”¨æ–¹æ³•:"
          echo "å¯åŠ¨æ–‡ä»¶å…±äº«: smbd -D"
          echo "å¯åŠ¨åç§°æœåŠ¡: nmbd -D"
          echo "æ·»åŠ ç”¨æˆ·: smbpasswd -a username"
          EOF
          
          chmod +x install.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba-armv7-binaries
          path: samba-deploy/*
          retention-days: 30

      - name: Show build success
        run: |
          echo "âœ… æž„å»ºæˆåŠŸ!"
          echo "ðŸ“¦ äºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          echo "ðŸ³ ä½¿ç”¨Dockerå®¹å™¨ç¼–è¯‘"
          echo "ðŸ–¥ï¸  æž¶æž„: ARMv7"
          echo "â° æ—¶é—´: $(date)"
