name: Build Samba for ARMv7 (Correct Configuration)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cross-compilation tools
        run: |
          echo "===== å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            pkg-config \
            curl \
            python3

      - name: Download Samba source
        run: |
          echo "===== ä¸‹è½½Sambaæºç  ====="
          # ä½¿ç”¨ç¨³å®šçš„Sambaç‰ˆæœ¬
          SAMBA_VERSION="4.17.0"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz

      - name: Configure Samba with correct options
        run: |
          echo "===== é…ç½®Samba (ä½¿ç”¨æ­£ç¡®çš„é€‰é¡¹) ====="
          cd samba-4.17.0
          
          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export AR="arm-linux-gnueabihf-ar"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"
          
          # ä½¿ç”¨æ­£ç¡®çš„é…ç½®é€‰é¡¹
          ./configure \
            --host=arm-linux-gnueabihf \
            --target=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --disable-avahi \
            --disable-cups \
            --disable-iprint \
            --disable-glusterfs \
            --without-acl-support \
            --without-ads \
            --without-pam \
            --without-gnutls \
            --nonshared-binary=smbd,nmbd,smbpasswd

      - name: Build Samba binaries
        run: |
          echo "===== ç¼–è¯‘SambaäºŒè¿›åˆ¶æ–‡ä»¶ ====="
          cd samba-4.17.0
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"
          
          # ç¼–è¯‘æ ¸å¿ƒç»„ä»¶
          make -j$(nproc) smbd nmbd smbpasswd

      - name: Alternative minimal build
        if: failure()
        run: |
          echo "===== æœ€å°åŒ–ç¼–è¯‘æ–¹æ¡ˆ ====="
          cd samba-4.17.0
          
          # å°è¯•åªç¼–è¯‘source3ç›®å½•
          cd source3
          
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"
          
          # ç®€å•çš„é…ç½®
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --disable-shared \
            --enable-static
          
          # ç¼–è¯‘æ ¸å¿ƒç»„ä»¶
          make -j$(nproc) smbd nmbd smbpasswd

      - name: Check and collect binaries
        run: |
          echo "===== æ£€æŸ¥å’Œæ”¶é›†äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          cd samba-4.17.0
          
          # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶
          mkdir -p ../samba-deploy
          
          # ä»Žbinç›®å½•å¤åˆ¶
          if [ -f "bin/smbd" ]; then
            cp bin/smbd bin/nmbd bin/smbpasswd ../samba-deploy/
            echo "âœ… ä»Žbinç›®å½•å¤åˆ¶æ–‡ä»¶"
          fi
          
          # ä»Žsource3/binç›®å½•å¤åˆ¶
          if [ -f "source3/bin/smbd" ]; then
            cp source3/bin/smbd source3/bin/nmbd source3/bin/smbpasswd ../samba-deploy/
            echo "âœ… ä»Žsource3/binç›®å½•å¤åˆ¶æ–‡ä»¶"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°æ–‡ä»¶
          if [ ! -f "../samba-deploy/smbd" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶"
            # å°è¯•æŸ¥æ‰¾ä»»ä½•ä½ç½®çš„äºŒè¿›åˆ¶æ–‡ä»¶
            find . -name "smbd" -type f -executable -exec cp {} ../samba-deploy/ \; 2>/dev/null || true
            find . -name "nmbd" -type f -executable -exec cp {} ../samba-deploy/ \; 2>/dev/null || true
            find . -name "smbpasswd" -type f -executable -exec cp {} ../samba-deploy/ \; 2>/dev/null || true
          fi

      - name: Verify binaries
        run: |
          echo "===== éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          cd samba-deploy
          
          if [ -f "smbd" ]; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶:"
            ls -la
            echo ""
            echo "æ–‡ä»¶ä¿¡æ¯:"
            file smbd
            echo ""
            echo "æž¶æž„æ£€æŸ¥:"
            arm-linux-gnueabihf-readelf -h smbd | grep "Machine:" | grep "ARM" || echo "æž¶æž„æ£€æŸ¥å¤±è´¥"
          else
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶"
            # åˆ›å»ºè¯¦ç»†çš„è¯´æ˜Žæ–‡æ¡£
            cat > INSTALL.md << 'EOF'
            # Samba for ARMv7 å®‰è£…æŒ‡å—
            
            ## ç¼–è¯‘å¤±è´¥è§£å†³æ–¹æ¡ˆ
            
            ### æ–¹æ¡ˆä¸€: åœ¨ç›®æ ‡è®¾å¤‡ä¸Šç›´æŽ¥ç¼–è¯‘
            1. ç™»å½•åˆ°æ‚¨çš„ARMè®¾å¤‡
            2. ä¸‹è½½Sambaæºç :
               ```bash
               wget https://download.samba.org/pub/samba/stable/samba-4.17.0.tar.gz
               tar -xzf samba-4.17.0.tar.gz
               cd samba-4.17.0
               ```
            3. é…ç½®å’Œç¼–è¯‘:
               ```bash
               ./configure --prefix=/usr --disable-python --without-ad-dc
               make -j$(nproc) smbd nmbd smbpasswd
               sudo make install
               ```
            
            ### æ–¹æ¡ˆäºŒ: ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…
            - **Debian/Ubuntu**:
              ```bash
              sudo apt update
              sudo apt install samba
              ```
            
            - **OpenWrt**:
              ```bash
              opkg update
              opkg install samba4-server
              ```
            
            - **CentOS/RHEL**:
              ```bash
              sudo yum install samba
              ```
            
            ### æ–¹æ¡ˆä¸‰: æ‰‹åŠ¨äº¤å‰ç¼–è¯‘
            åœ¨x86æœºå™¨ä¸Š:
            1. å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·:
               ```bash
               sudo apt install gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
               ```
            2. ä¸‹è½½å¹¶ç¼–è¯‘Samba:
               ```bash
               wget https://download.samba.org/pub/samba/stable/samba-4.17.0.tar.gz
               tar -xzf samba-4.17.0.tar.gz
               cd samba-4.17.0
               ./configure --host=arm-linux-gnueabihf --prefix=/usr
               make smbd nmbd smbpasswd
               ```
            
            ## é…ç½®Samba
            å®‰è£…åŽåˆ›å»º `/etc/samba/smb.conf`:
            ```ini
            [global]
            workgroup = WORKGROUP
            server string = Samba Server
            security = user
            map to guest = Bad User
            
            [shared]
            comment = Shared Folder
            path = /mnt/shared
            browseable = yes
            writable = yes
            guest ok = no
            ```
            EOF
          fi

      - name: Create installation package
        run: |
          echo "===== åˆ›å»ºå®‰è£…åŒ… ====="
          cd samba-deploy
          
          if [ -f "smbd" ]; then
            # åˆ›å»ºå®‰è£…è„šæœ¬
            cat > install.sh << 'EOF'
            #!/bin/sh
            echo "=== Samba ARMv7 å®‰è£…ç¨‹åº ==="
            echo ""
            
            # æ£€æŸ¥æƒé™
            if [ "$(id -u)" -ne 0 ]; then
              echo "é”™è¯¯: éœ€è¦rootæƒé™"
              echo "è¯·ä½¿ç”¨: sudo ./install.sh"
              exit 1
            fi
            
            echo "å¼€å§‹å®‰è£…SambaäºŒè¿›åˆ¶æ–‡ä»¶..."
            echo ""
            
            # å®‰è£…æ¯ä¸ªæ–‡ä»¶
            for bin_file in smbd nmbd smbpasswd; do
              if [ -f "$bin_file" ]; then
                # å¤‡ä»½åŽŸæœ‰æ–‡ä»¶
                if [ -f "/usr/sbin/$bin_file" ]; then
                  backup_name="/usr/sbin/${bin_file}.backup.$(date +%Y%m%d_%H%M%S)"
                  mv "/usr/sbin/$bin_file" "$backup_name"
                  echo "å·²å¤‡ä»½: $backup_name"
                fi
                
                # å®‰è£…æ–°æ–‡ä»¶
                install -m 755 "$bin_file" "/usr/sbin/"
                echo "å·²å®‰è£…: /usr/sbin/$bin_file"
              else
                echo "è­¦å‘Š: æ‰¾ä¸åˆ°æ–‡ä»¶ $bin_file"
              fi
            done
            
            echo ""
            echo "=== å®‰è£…å®Œæˆ ==="
            echo ""
            echo "ä¸‹ä¸€æ­¥æ“ä½œ:"
            echo "1. åˆ›å»ºé…ç½®æ–‡ä»¶: /etc/samba/smb.conf"
            echo "2. å¯åŠ¨æœåŠ¡:"
            echo "   smbd -D"
            echo "   nmbd -D"
            echo "3. æ·»åŠ ç”¨æˆ·: smbpasswd -a ç”¨æˆ·å"
            echo ""
            echo "æŸ¥çœ‹ç¤ºä¾‹é…ç½®: cat smb.conf.example"
            EOF
            
            chmod +x install.sh
            
            # åˆ›å»ºé…ç½®æ–‡ä»¶ç¤ºä¾‹
            cat > smb.conf.example << 'EOF'
            [global]
            workgroup = WORKGROUP
            netbios name = SAMBA_SERVER
            server string = Samba Server
            security = user
            map to guest = Bad User
            log file = /var/log/samba/log.%m
            max log size = 50

            [homes]
            comment = Home Directories
            browseable = no
            writable = yes
            valid users = %S

            [shared]
            comment = Shared Folder
            path = /mnt/shared
            browseable = yes
            writable = yes
            guest ok = no
            create mask = 0644
            directory mask = 0755
            EOF
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba-armv7
          path: samba-deploy/*
          retention-days: 30

      - name: Show final status
        run: |
          if [ -f "samba-deploy/smbd" ]; then
            echo "âœ… æž„å»ºæˆåŠŸ!"
            echo "ðŸ“¦ äºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifacts"
            echo "ðŸ–¥ï¸  æž¶æž„: ARMv7"
            echo "ðŸ“Š åŒ…å«: smbd, nmbd, smbpasswd"
          else
            echo "âš ï¸ è‡ªåŠ¨ç¼–è¯‘å¤±è´¥"
            echo "ðŸ“‹ å·²ä¸Šä¼ è¯¦ç»†çš„å®‰è£…æŒ‡å—"
            echo "ðŸ’¡ å»ºè®®åœ¨ç›®æ ‡ARMè®¾å¤‡ä¸Šç›´æŽ¥ç¼–è¯‘"
          fi
          echo "â° å®Œæˆæ—¶é—´: $(date)"
