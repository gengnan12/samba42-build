name: Build Samba 4 for ARMv7 (Fix Time Bits Error)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install basic tools
        run: |
          echo "===== å®‰è£…åŸºç¡€å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            python3 python3-dev \
            pkg-config \
            curl

      - name: Build zlib from source (with fix)
        run: |
          echo "===== ç¼–è¯‘zlib (ä¿®å¤_TIME_BITSé”™è¯¯) ====="
          # ä¸‹è½½zlib
          wget https://zlib.net/zlib-1.2.13.tar.gz || \
          wget https://github.com/madler/zlib/releases/download/v1.2.13/zlib-1.2.13.tar.gz
          
          tar -xzf zlib-1.2.13.tar.gz
          cd zlib-1.2.13
          
          # è®¾ç½®ç¼–è¯‘æ ‡å¿—ï¼Œä¿®å¤_TIME_BITSé”™è¯¯
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os -U_TIME_BITS -U_FILE_OFFSET_BITS"
          export LDFLAGS="-static"
          
          # ä½¿ç”¨configureè„šæœ¬
          ./configure --prefix=/opt/arm-deps --static
          
          # æˆ–è€…ç›´æ¥ä½¿ç”¨make
          make -j$(nproc) CC="${CC}" CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}"
          sudo make install
          cd ..

      - name: Build OpenSSL from source
        run: |
          echo "===== ç¼–è¯‘OpenSSL ====="
          wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz || \
          wget https://github.com/openssl/openssl/releases/download/OpenSSL_1_1_1w/openssl-1.1.1w.tar.gz
          
          tar -xzf openssl-1.1.1w.tar.gz
          cd openssl-1.1.1w
          
          # è®¾ç½®ç¼–è¯‘æ ‡å¿—
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os -U_TIME_BITS -U_FILE_OFFSET_BITS"
          
          ./Configure linux-armv4 \
            --prefix=/opt/arm-deps \
            no-shared \
            no-dso \
            ${CFLAGS}
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Build GnuTLS from source
        run: |
          echo "===== ç¼–è¯‘GnuTLS ====="
          # ä½¿ç”¨è¾ƒæ—§çš„å…¼å®¹ç‰ˆæœ¬
          wget https://www.gnupg.org/ftp/gcrypt/gnutls/v3.6/gnutls-3.6.16.tar.xz || \
          wget https://ftp.gnu.org/gnu/gnutls/gnutls-3.6.16.tar.xz
          
          tar -xJf gnutls-3.6.16.tar.xz
          cd gnutls-3.6.16
          
          # è®¾ç½®ç¼–è¯‘æ ‡å¿—
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os -U_TIME_BITS -U_FILE_OFFSET_BITS -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static"
          export PKG_CONFIG_PATH="/opt/arm-deps/lib/pkgconfig"
          
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/opt/arm-deps \
            --with-libz-prefix=/opt/arm-deps \
            --with-included-libtasn1 \
            --with-included-unistring \
            --without-p11-kit \
            --disable-doc \
            --disable-tests \
            --enable-static \
            --disable-shared \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}"
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Download and compile Samba 4.8
        run: |
          echo "===== ä¸‹è½½å’Œç¼–è¯‘Samba ====="
          # ä½¿ç”¨æ›´æ—§çš„Sambaç‰ˆæœ¬ä»¥ç¡®ä¿å…¼å®¹æ€§
          wget https://download.samba.org/pub/samba/stable/samba-4.8.12.tar.gz || \
          wget https://download.samba.org/pub/samba/old/4.8.12/samba-4.8.12.tar.gz
          
          tar -xzf samba-4.8.12.tar.gz
          cd samba-4.8.12

          # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
          export PKG_CONFIG_PATH="/opt/arm-deps/lib/pkgconfig"
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os -U_TIME_BITS -U_FILE_OFFSET_BITS -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static -lssl -lcrypto -lz"

          # é…ç½®Samba
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --with-gnutls=/opt/arm-deps \
            --with-zlib=/opt/arm-deps \
            --enable-static \
            --disable-shared \
            --without-acl-support \
            --without-ads \
            --without-pam \
            ac_cv_func_fstatfs=yes

          # ç¼–è¯‘
          make -j$(nproc) all

      - name: Verify static binaries
        run: |
          echo "===== éªŒè¯é™æ€äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          cd samba-4.8.12/bin
          
          # æ£€æŸ¥æ–‡ä»¶ç±»å‹
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file smbd
          file nmbd
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€é“¾æ¥
          echo "é“¾æ¥æ£€æŸ¥:"
          if arm-linux-gnueabihf-readelf -d smbd | grep -q "Shared library"; then
            echo "é”™è¯¯: äºŒè¿›åˆ¶æ–‡ä»¶ä¸æ˜¯é™æ€é“¾æ¥"
            exit 1
          else
            echo "âœ“ äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€é“¾æ¥çš„"
          fi
          
          # æ£€æŸ¥æ¶æ„
          echo "æ¶æ„æ£€æŸ¥:"
          if arm-linux-gnueabihf-readelf -h smbd | grep -q "ARM"; then
            echo "âœ“ ARMæ¶æ„æ­£ç¡®"
          else
            echo "é”™è¯¯: ä¸æ˜¯ARMæ¶æ„"
            exit 1
          fi

      - name: Create deployment package
        run: |
          echo "===== åˆ›å»ºéƒ¨ç½²åŒ… ====="
          mkdir -p samba-deploy
          cd samba-4.8.12/bin
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp smbd nmbd smbpasswd ../../samba-deploy/
          
          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > ../../samba-deploy/install.sh << 'EOF'
          #!/bin/sh
          echo "å®‰è£…Sambaé™æ€äºŒè¿›åˆ¶æ–‡ä»¶..."
          echo "ç³»ç»Ÿä¿¡æ¯: $(uname -a)"
          
          # å¤‡ä»½åŸæœ‰æ–‡ä»¶
          for bin in smbd nmbd smbpasswd; do
            if [ -f "/usr/sbin/$bin" ]; then
              mv "/usr/sbin/$bin" "/usr/sbin/${bin}.backup"
              echo "å·²å¤‡ä»½: /usr/sbin/${bin}.backup"
            fi
          done
          
          # å®‰è£…æ–°æ–‡ä»¶
          cp smbd nmbd smbpasswd /usr/sbin/
          chmod 755 /usr/sbin/smbd /usr/sbin/nmbd /usr/sbin/smbpasswd
          
          echo "å®‰è£…å®Œæˆ!"
          echo ""
          echo "ä½¿ç”¨æ–¹æ³•:"
          echo "å¯åŠ¨smbd: smbd -D"
          echo "å¯åŠ¨nmbd: nmbd -D"
          echo "æ·»åŠ ç”¨æˆ·: smbpasswd -a username"
          EOF
          
          chmod +x ../../samba-deploy/install.sh
          
          # åˆ›å»ºæµ‹è¯•è„šæœ¬
          cat > ../../samba-deploy/test-binary.sh << 'EOF'
          #!/bin/sh
          echo "æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶å…¼å®¹æ€§..."
          echo "æ£€æŸ¥smbd:"
          ./smbd -V || echo "ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ"
          echo ""
          echo "æ£€æŸ¥nmbd:"
          ./nmbd -V || echo "ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ"
          echo ""
          echo "äºŒè¿›åˆ¶æ–‡ä»¶æµ‹è¯•å®Œæˆ"
          EOF
          
          chmod +x ../../samba-deploy/test-binary.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba4.8-armv7-static
          path: samba-deploy/*
          retention-days: 30

      - name: Show build success
        run: |
          echo "âœ… æ„å»ºæˆåŠŸ!"
          echo "ğŸ“¦ ç”Ÿæˆçš„é™æ€äºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          echo "ğŸ–¥ï¸  é€‚ç”¨äº: ARMv7, Linux 4.1.x (Buildroot 2017)"
          echo "ğŸ”— é“¾æ¥æ–¹å¼: å®Œå…¨é™æ€é“¾æ¥"
          echo "ğŸ› å·²ä¿®å¤: _TIME_BITS=64 é”™è¯¯"
          echo "â° æ„å»ºæ—¶é—´: $(date)"
