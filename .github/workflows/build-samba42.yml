name: Build Samba 4 for ARMv7 (With Nettle and GMP)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install basic tools
        run: |
          echo "===== 安装基础工具 ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            python3 python3-dev \
            pkg-config \
            curl

      - name: Build zlib from source
        run: |
          echo "===== 编译zlib ====="
          wget https://zlib.net/zlib-1.2.13.tar.gz || \
          wget https://github.com/madler/zlib/releases/download/v1.2.13/zlib-1.2.13.tar.gz
          
          tar -xzf zlib-1.2.13.tar.gz
          cd zlib-1.2.13
          
          CC="arm-linux-gnueabihf-gcc" \
          CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS" \
          ./configure --prefix=/opt/arm-deps --static
          
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Build GMP from source
        run: |
          echo "===== 编译GMP ====="
          wget https://gmplib.org/download/gmp/gmp-6.2.1.tar.xz || \
          wget https://ftp.gnu.org/gnu/gmp/gmp-6.2.1.tar.xz
          
          tar -xJf gmp-6.2.1.tar.xz
          cd gmp-6.2.1
          
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS"
          export LDFLAGS="-static"
          
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/opt/arm-deps \
            --enable-static \
            --disable-shared \
            --disable-cxx \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}"
          
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Build OpenSSL from source
        run: |
          echo "===== 编译OpenSSL ====="
          wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz || \
          wget https://github.com/openssl/openssl/releases/download/OpenSSL_1_1_1w/openssl-1.1.1w.tar.gz
          
          tar -xzf openssl-1.1.1w.tar.gz
          cd openssl-1.1.1w
          
          export CROSS_COMPILE="arm-linux-gnueabihf-"
          export CC="${CROSS_COMPILE}gcc"
          export AR="${CROSS_COMPILE}ar"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS"
          
          ./Configure linux-armv4 \
            --prefix=/opt/arm-deps \
            no-shared \
            no-dso \
            no-asm \
            ${CFLAGS}
          
          sed -i 's/^CC=.*/CC=$(CROSS_COMPILE)gcc/' Makefile
          sed -i 's/^AR=.*/AR=$(CROSS_COMPILE)ar/' Makefile
          
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Build Nettle with GMP support
        run: |
          echo "===== 编译Nettle (带GMP支持) ====="
          wget https://ftp.gnu.org/gnu/nettle/nettle-3.4.1.tar.gz || \
          wget https://mirrors.kernel.org/gnu/nettle/nettle-3.4.1.tar.gz
          
          tar -xzf nettle-3.4.1.tar.gz
          cd nettle-3.4.1
          
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static"
          export PKG_CONFIG_PATH="/opt/arm-deps/lib/pkgconfig"
          
          # 配置nettle启用GMP支持
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/opt/arm-deps \
            --enable-static \
            --disable-shared \
            --disable-documentation \
            --enable-mini-gmp \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            --with-include-path=/opt/arm-deps/include \
            --with-lib-path=/opt/arm-deps/lib
          
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Build GnuTLS from source
        run: |
          echo "===== 编译GnuTLS ====="
          wget https://www.gnupg.org/ftp/gcrypt/gnutls/v3.6/gnutls-3.6.16.tar.xz || \
          wget https://ftp.gnu.org/gnu/gnutls/gnutls-3.6.16.tar.xz
          
          tar -xJf gnutls-3.6.16.tar.xz
          cd gnutls-3.6.16
          
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static"
          export PKG_CONFIG_PATH="/opt/arm-deps/lib/pkgconfig"
          
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/opt/arm-deps \
            --with-libz-prefix=/opt/arm-deps \
            --with-included-libtasn1 \
            --with-included-unistring \
            --without-p11-kit \
            --disable-doc \
            --disable-tests \
            --enable-static \
            --disable-shared \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}"
          
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Download and compile Samba 4.8
        run: |
          echo "===== 下载和编译Samba ====="
          wget https://download.samba.org/pub/samba/stable/samba-4.8.12.tar.gz || \
          wget https://download.samba.org/pub/samba/old/4.8.12/samba-4.8.12.tar.gz
          
          tar -xzf samba-4.8.12.tar.gz
          cd samba-4.8.12

          export PKG_CONFIG_PATH="/opt/arm-deps/lib/pkgconfig"
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static -lssl -lcrypto -lz -lnettle -lhogweed -lgmp"

          # 配置Samba，确保找到所有依赖
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --with-gnutls=/opt/arm-deps \
            --with-zlib=/opt/arm-deps \
            --enable-static \
            --disable-shared \
            --without-acl-support \
            --without-ads \
            --without-pam \
            nettle_CFLAGS="-I/opt/arm-deps/include" \
            nettle_LIBS="-L/opt/arm-deps/lib -lnettle -lhogweed" \
            hogweed_CFLAGS="-I/opt/arm-deps/include" \
            hogweed_LIBS="-L/opt/arm-deps/lib -lhogweed" \
            ac_cv_func_fstatfs=yes

          make -j$(nproc) all

      - name: Verify binaries
        run: |
          echo "===== 验证二进制文件 ====="
          cd samba-4.8.12/bin
          
          echo "文件信息:"
          file smbd
          file nmbd
          file smbpasswd
          
          echo "架构检查:"
          arm-linux-gnueabihf-readelf -h smbd | grep "Machine:" | grep "ARM" || exit 1
          
          echo "依赖检查:"
          arm-linux-gnueabihf-readelf -d smbd | grep "Shared library" || echo "✓ 无动态库依赖"

      - name: Create deployment package
        run: |
          echo "===== 创建部署包 ====="
          mkdir -p samba-deploy
          cd samba-4.8.12/bin
          
          cp smbd nmbd smbpasswd ../../samba-deploy/
          
          # 创建安装脚本
          cat > ../../samba-deploy/install.sh << 'EOF'
          #!/bin/sh
          echo "安装Samba for ARMv7..."
          echo "系统: $(uname -a)"
          
          # 安装二进制文件
          install -m 755 smbd /usr/sbin/smbd
          install -m 755 nmbd /usr/sbin/nmbd
          install -m 755 smbpasswd /usr/sbin/smbpasswd
          
          echo "安装完成!"
          echo ""
          echo "使用方法:"
          echo "启动服务: smbd -D && nmbd -D"
          echo "添加用户: smbpasswd -a username"
          EOF
          
          chmod +x ../../samba-deploy/install.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba4.8-armv7-complete
          path: samba-deploy/*
          retention-days: 30

      - name: Show build success
        run: |
          echo "✅ 构建成功!"
          echo "📦 包含: Samba 4.8.12 + Nettle + GMP + Hogweed"
          echo "🖥️  架构: ARMv7"
          echo "🔗 链接: 完全静态"
          echo "⏰ 时间: $(date)"
