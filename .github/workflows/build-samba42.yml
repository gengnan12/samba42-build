name: Build Samba for ARMv7 (Fixed Cross-Compilation)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cross-compilation tools
        run: |
          echo "===== å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            pkg-config \
            curl \
            python3 \
            libc6-dev-armhf-cross \
            binutils-arm-linux-gnueabihf

      - name: Verify cross-compilation toolchain
        run: |
          echo "===== éªŒè¯äº¤å‰ç¼–è¯‘å·¥å…·é“¾ ====="
          echo "GCCç‰ˆæœ¬:"
          arm-linux-gnueabihf-gcc --version
          echo ""
          echo "G++ç‰ˆæœ¬:"
          arm-linux-gnueabihf-g++ --version
          echo ""
          echo "å·¥å…·é“¾ä½ç½®:"
          which arm-linux-gnueabihf-gcc
          which arm-linux-gnueabihf-g++

      - name: Download Samba source
        run: |
          echo "===== ä¸‹è½½Sambaæºç  ====="
          # ä½¿ç”¨æ›´ç¨³å®šçš„Sambaç‰ˆæœ¬
          SAMBA_VERSION="4.15.0"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz

      - name: Create cross-compilation environment
        run: |
          echo "===== åˆ›å»ºäº¤å‰ç¼–è¯‘çŽ¯å¢ƒ ====="
          cd samba-4.15.0
          
          # åˆ›å»ºäº¤å‰ç¼–è¯‘é…ç½®æ–‡ä»¶
          cat > cross-answers.txt << 'EOF'
          Checking uname sysname type: "Linux"
          Checking uname machine type: "armv7l"
          Checking uname release type: "4.1.52"
          Checking uname version type: "#1 SMP PREEMPT Sat Sep 18 17:36:44 CST 2021"
          Checking simple C program: yes
          EOF

      - name: Configure Samba for cross-compilation
        run: |
          echo "===== é…ç½®Sambaäº¤å‰ç¼–è¯‘ ====="
          cd samba-4.15.0
          
          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export AR="arm-linux-gnueabihf-ar"
          export RANLIB="arm-linux-gnueabihf-ranlib"
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os"
          export LDFLAGS="-static"
          export CONFIG_SITE=/dev/null
          
          # ä½¿ç”¨äº¤å‰ç¼–è¯‘é…ç½®
          ./configure \
            --cross-compile \
            --cross-answers=cross-answers.txt \
            --host=arm-linux-gnueabihf \
            --target=arm-linux-gnueabihf \
            --prefix=/usr \
            --disable-python \
            --without-ad-dc \
            --without-ldap \
            --disable-avahi \
            --disable-cups \
            --disable-iprint

      - name: Build Samba with waf
        run: |
          echo "===== ä½¿ç”¨wafç¼–è¯‘Samba ====="
          cd samba-4.15.0
          
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os"
          export LDFLAGS="-static"
          
          # ä½¿ç”¨wafç¼–è¯‘ç‰¹å®šç›®æ ‡
          ./buildtools/bin/waf build --targets=smbd,nmbd,bin/smbpasswd

      - name: Alternative direct build
        if: failure()
        run: |
          echo "===== ç›´æŽ¥ç¼–è¯‘æ ¸å¿ƒç»„ä»¶ ====="
          cd samba-4.15.0
          
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os"
          export LDFLAGS="-static"
          
          # ç›´æŽ¥ç¼–è¯‘
          make -j$(nproc) CC="${CC}" CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}" smbd nmbd smbpasswd

      - name: Check and collect binaries
        run: |
          echo "===== æ£€æŸ¥å’Œæ”¶é›†äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          cd samba-4.15.0
          
          mkdir -p ../samba-deploy
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f "bin/smbd" ]; then
            cp bin/smbd bin/nmbd bin/smbpasswd ../samba-deploy/
          elif [ -f "bin/default/source3/smbd/smbd" ]; then
            cp bin/default/source3/smbd/smbd ../samba-deploy/smbd
            cp bin/default/source3/nmbd/nmbd ../samba-deploy/nmbd
            cp bin/default/source3/utils/smbpasswd ../samba-deploy/smbpasswd
          else
            # æœç´¢æ•´ä¸ªç›®å½•
            find . -name "smbd" -type f -executable -exec cp {} ../samba-deploy/ \; 2>/dev/null || true
            find . -name "nmbd" -type f -executable -exec cp {} ../samba-deploy/ \; 2>/dev/null || true
            find . -name "smbpasswd" -type f -executable -exec cp {} ../samba-deploy/ \; 2>/dev/null || true
          fi

      - name: Verify binaries
        run: |
          echo "===== éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          cd samba-deploy
          
          if [ -f "smbd" ]; then
            echo "âœ… æ‰¾åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶:"
            ls -la
            echo ""
            echo "æ–‡ä»¶ç±»åž‹:"
            file smbd
            echo ""
            echo "æž¶æž„æ£€æŸ¥:"
            arm-linux-gnueabihf-readelf -h smbd | grep "Machine:" | grep "ARM" || echo "æž¶æž„æ£€æŸ¥å¤±è´¥"
          else
            echo "âŒ æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåˆ›å»ºæ‰‹åŠ¨ç¼–è¯‘æŒ‡å—"
            
            cat > COMPILE_GUIDE.md << 'EOF'
            # Samba for ARMv7 æ‰‹åŠ¨ç¼–è¯‘æŒ‡å—
            
            ## é—®é¢˜åˆ†æž
            è‡ªåŠ¨äº¤å‰ç¼–è¯‘å¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºå·¥å…·é“¾é…ç½®é—®é¢˜ã€‚
            
            ## è§£å†³æ–¹æ¡ˆ
            
            ### æ–¹æ¡ˆä¸€: åœ¨ç›®æ ‡è®¾å¤‡ä¸Šç›´æŽ¥ç¼–è¯‘
            ```bash
            # åœ¨æ‚¨çš„ARMè®¾å¤‡ä¸Šæ‰§è¡Œ
            wget https://download.samba.org/pub/samba/stable/samba-4.15.0.tar.gz
            tar -xzf samba-4.15.0.tar.gz
            cd samba-4.15.0
            ./configure --prefix=/usr --disable-python --without-ad-dc
            make -j$(nproc) smbd nmbd smbpasswd
            sudo make install
            ```
            
            ### æ–¹æ¡ˆäºŒ: ä½¿ç”¨æ­£ç¡®çš„äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
            ```bash
            # åœ¨x86æœºå™¨ä¸Š
            sudo apt install gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf binutils-arm-linux-gnueabihf
            
            # åˆ›å»ºäº¤å‰ç¼–è¯‘ç­”æ¡ˆæ–‡ä»¶
            cat > cross-answers.txt << 'END'
            Checking uname sysname type: "Linux"
            Checking uname machine type: "armv7l"
            Checking uname release type: "4.1.52"
            Checking uname version type: "#1 SMP PREEMPT Sat Sep 18 17:36:44 CST 2021"
            Checking simple C program: yes
            END
            
            # é…ç½®å’Œç¼–è¯‘
            ./configure --cross-compile --cross-answers=cross-answers.txt \
                        --host=arm-linux-gnueabihf --prefix=/usr
            make smbd nmbd smbpasswd
            ```
            
            ### æ–¹æ¡ˆä¸‰: ä½¿ç”¨åŒ…ç®¡ç†å™¨
            ```bash
            # Debian/Ubuntu
            sudo apt install samba
            
            # OpenWrt
            opkg install samba4-server
            
            # CentOS/RHEL
            sudo yum install samba
            ```
            
            ## é…ç½®ç¤ºä¾‹
            `/etc/samba/smb.conf`:
            ```ini
            [global]
            workgroup = WORKGROUP
            security = user
            map to guest = Bad User
            
            [shared]
            path = /mnt/shared
            browseable = yes
            writable = yes
            guest ok = no
            ```
            EOF
          fi

      - name: Create installation package
        run: |
          echo "===== åˆ›å»ºå®‰è£…åŒ… ====="
          cd samba-deploy
          
          if [ -f "smbd" ]; then
            cat > install.sh << 'EOF'
            #!/bin/sh
            echo "=== Samba ARMv7 å®‰è£…ç¨‹åº ==="
            
            if [ "$(id -u)" -ne 0 ]; then
              echo "è¯·ä½¿ç”¨rootæƒé™è¿è¡Œ: sudo ./install.sh"
              exit 1
            fi
            
            echo "å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶..."
            
            for bin in smbd nmbd smbpasswd; do
              if [ -f "$bin" ]; then
                install -m 755 "$bin" "/usr/sbin/"
                echo "å·²å®‰è£…: /usr/sbin/$bin"
              fi
            done
            
            echo "å®‰è£…å®Œæˆ!"
            echo "ä½¿ç”¨æ–¹æ³•: smbd -D && nmbd -D"
            EOF
            
            chmod +x install.sh
            
            cat > smb.conf.example << 'EOF'
            [global]
            workgroup = WORKGROUP
            security = user
            map to guest = Bad User
            
            [shared]
            path = /mnt/shared
            browseable = yes
            writable = yes
            guest ok = no
            EOF
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba-armv7
          path: samba-deploy/*
          retention-days: 30

      - name: Show results
        run: |
          if [ -f "samba-deploy/smbd" ]; then
            echo "âœ… æž„å»ºæˆåŠŸ!"
            echo "ðŸ“¦ äºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸Šä¼ "
          else
            echo "âš ï¸ äº¤å‰ç¼–è¯‘é‡åˆ°é—®é¢˜"
            echo "ðŸ“‹ å·²ä¸Šä¼ è¯¦ç»†çš„æ‰‹åŠ¨ç¼–è¯‘æŒ‡å—"
            echo "ðŸ’¡ å»ºè®®åœ¨ç›®æ ‡è®¾å¤‡ä¸Šç›´æŽ¥ç¼–è¯‘"
          fi
