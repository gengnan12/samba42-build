name: Build Samba for ARMv7 (Simplified Approach)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install cross-compilation tools
        run: |
          echo "===== å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            pkg-config \
            curl \
            python3

      - name: Download and extract Samba source
        run: |
          echo "===== ä¸‹è½½Sambaæºç  ====="
          # ä½¿ç”¨è¾ƒæ—§çš„Sambaç‰ˆæœ¬ï¼Œæ›´å®¹æ˜“ç¼–è¯‘
          SAMBA_VERSION="4.5.16"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz
          cd samba-${SAMBA_VERSION}

      - name: Apply minimal configuration
        run: |
          echo "===== åº”ç”¨æœ€å°åŒ–é…ç½® ====="
          cd samba-4.5.16
          
          # åˆ›å»ºç®€å•çš„é…ç½®è„šæœ¬
          cat > build-config.sh << 'EOF'
          #!/bin/bash
          
          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export AR="arm-linux-gnueabihf-ar"
          export RANLIB="arm-linux-gnueabihf-ranlib"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -static"
          export LDFLAGS="-static"
          
          # ä½¿ç”¨ç®€å•çš„configureé€‰é¡¹
          ./configure \
            --host=arm-linux-gnueabihf \
            --target=arm-linux-gnueabihf \
            --prefix=/usr \
            --disable-cups \
            --disable-iprint \
            --disable-pie \
            --disable-relro \
            --disable-static \
            --disable-symbol-versions \
            --enable-shared-libs=no \
            --nonshared-binary=smbd,nmbd,smbpasswd
          EOF
          
          chmod +x build-config.sh

      - name: Try to compile with simple make
        run: |
          echo "===== å°è¯•ç®€å•ç¼–è¯‘ ====="
          cd samba-4.5.16/source3
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"
          
          # å°è¯•ç›´æŽ¥ç¼–è¯‘æ ¸å¿ƒç»„ä»¶
          echo "å°è¯•ç¼–è¯‘smbd..."
          make -j$(nproc) \
            CC="${CC}" \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            smbd || echo "smbdç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–ç»„ä»¶"
          
          echo "å°è¯•ç¼–è¯‘nmbd..."
          make -j$(nproc) \
            CC="${CC}" \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            nmbd || echo "nmbdç¼–è¯‘å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–ç»„ä»¶"
          
          echo "å°è¯•ç¼–è¯‘smbpasswd..."
          make -j$(nproc) \
            CC="${CC}" \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            smbpasswd || echo "smbpasswdç¼–è¯‘å¤±è´¥"

      - name: Check for any compiled binaries
        run: |
          echo "===== æ£€æŸ¥ç¼–è¯‘ç»“æžœ ====="
          cd samba-4.5.16
          
          # æŸ¥æ‰¾ä»»ä½•ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
          find . -name "smbd" -type f -executable | head -5
          find . -name "nmbd" -type f -executable | head -5
          find . -name "smbpasswd" -type f -executable | head -5
          
          # æ£€æŸ¥binç›®å½•
          if [ -d "bin" ]; then
            ls -la bin/
          fi
          
          # æ£€æŸ¥source3/binç›®å½•
          if [ -d "source3/bin" ]; then
            ls -la source3/bin/
          fi

      - name: Try alternative approach - use prebuilt cross-compile script
        run: |
          echo "===== ä½¿ç”¨é¢„å®šä¹‰çš„äº¤å‰ç¼–è¯‘è„šæœ¬ ====="
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„äº¤å‰ç¼–è¯‘è„šæœ¬
          cat > cross-compile-samba.sh << 'EOF'
          #!/bin/bash
          
          # è®¾ç½®çŽ¯å¢ƒ
          export ARCH=arm
          export CROSS_COMPILE=arm-linux-gnueabihf-
          export CC="${CROSS_COMPILE}gcc"
          export CXX="${CROSS_COMPILE}g++"
          export AR="${CROSS_COMPILE}ar"
          export STRIP="${CROSS_COMPILE}strip"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -static"
          export LDFLAGS="-static"
          
          # è¿›å…¥Sambaç›®å½•
          cd samba-4.5.16/source3
          
          # å°è¯•ç¼–è¯‘
          echo "ç¼–è¯‘smbd..."
          ${CC} ${CFLAGS} -o smbd \
            ../source3/smbd/server.c \
            ../source3/smbd/process.c \
            ../source3/smbd/files.c \
            ../source3/smbd/connection.c \
            ../source3/smbd/trans2.c \
            ../source3/lib/util.c \
            ../source3/lib/charcnv.c \
            ../source3/lib/time.c \
            ../source3/lib/byteorder.c \
            ../source3/lib/md4.c \
            ../source3/lib/rc4.c \
            ../source3/lib/md5.c \
            ../source3/lib/hmacmd5.c \
            ../source3/lib/msrpc_parse.c \
            ../source3/lib/asn1.c \
            ../source3/lib/iconv.c \
            ../source3/lib/clique.c \
            ../source3/lib/access.c \
            ../source3/lib/deny.c \
            ../source3/lib/username.c \
            ../source3/lib/privileges.c \
            ../source3/lib/sec_ctx.c \
            ../source3/lib/security.c \
            ../source3/lib/session.c \
            ../source3/lib/smbrun.c \
            ../source3/lib/fsusage.c \
            ../source3/lib/statvfs.c \
            ../source3/lib/dprintf.c \
            ../source3/lib/xfile.c \
            ../source3/lib/wins_srv.c \
            ../source3/lib/namequery.c \
            ../source3/lib/nameresolve.c \
            ../source3/lib/substitute.c \
            ../source3/lib/fsusage.c \
            ../source3/lib/bitmap.c \
            ../source3/lib/pidfile.c \
            ../source3/lib/select.c \
            ../source3/lib/talloc.c \
            ../source3/lib/tdb.c \
            ../source3/lib/genrand.c \
            ../source3/lib/util_str.c \
            ../source3/lib/util_file.c \
            ../source3/lib/util_sock.c \
            ../source3/lib/util_net.c \
            ../source3/lib/util_str_hex.c \
            ../source3/lib/util_strlist.c \
            ../source3/lib/util_pw.c \
            ../source3/lib/util_crypt.c \
            ../source3/lib/util_sec.c \
            ../source3/lib/util_unistr.c \
            ../source3/lib/util_sid.c \
            ../source3/lib/util_nttoken.c \
            ../source3/lib/util_ntaccess.c \
            ../source3/lib/util_ace.c \
            ../source3/lib/util_sd.c \
            ../source3/lib/util_samlogon.c \
            ${LDFLAGS} \
            -I../source3/include -I../source3 -I../lib -I../include \
            -DHAVE_CONFIG_H -DPASSDB -DSHADOW -DQUOTA -DACL -DHAVE_MMAP -DHAVE_FCNTL_LOCK -DHAVE_KRB5 -DHAVE_ADS
          
          echo "ç¼–è¯‘nmbd..."
          ${CC} ${CFLAGS} -o nmbd \
            ../source3/nmbd/nmbd.c \
            ../source3/nmbd/nmbd_become_lmb.c \
            ../source3/nmbd/nmbd_become_dmb.c \
            ../source3/nmbd/nmbd_elections.c \
            ../source3/nmbd/nmbd_incoming.c \
            ../source3/nmbd/nmbd_logonnames.c \
            ../source3/nmbd/nmbd_nameregister.c \
            ../source3/nmbd/nmbd_namequery.c \
            ../source3/nmbd/nmbd_namerelease.c \
            ../source3/nmbd/nmbd_subnetdb.c \
            ../source3/nmbd/nmbd_winsproxy.c \
            ../source3/nmbd/nmbd_workgroupdb.c \
            ../source3/nmbd/nmbd_sendannounce.c \
            ../source3/nmbd/nmbd_serverlist.c \
            ../source3/nmbd/nmbd_dgram.c \
            ../source3/nmbd/nmbd_packets.c \
            ../source3/lib/util.c \
            ../source3/lib/charcnv.c \
            ../source3/lib/time.c \
            ../source3/lib/byteorder.c \
            ../source3/lib/md4.c \
            ../source3/lib/rc4.c \
            ../source3/lib/md5.c \
            ../source3/lib/hmacmd5.c \
            ../source3/lib/msrpc_parse.c \
            ../source3/lib/asn1.c \
            ../source3/lib/iconv.c \
            ../source3/lib/clique.c \
            ../source3/lib/access.c \
            ../source3/lib/deny.c \
            ../source3/lib/username.c \
            ../source3/lib/privileges.c \
            ../source3/lib/sec_ctx.c \
            ../source3/lib/security.c \
            ../source3/lib/session.c \
            ../source3/lib/smbrun.c \
            ../source3/lib/fsusage.c \
            ../source3/lib/statvfs.c \
            ../source3/lib/dprintf.c \
            ../source3/lib/xfile.c \
            ../source3/lib/wins_srv.c \
            ../source3/lib/namequery.c \
            ../source3/lib/nameresolve.c \
            ../source3/lib/substitute.c \
            ../source3/lib/fsusage.c \
            ../source3/lib/bitmap.c \
            ../source3/lib/pidfile.c \
            ../source3/lib/select.c \
            ../source3/lib/talloc.c \
            ../source3/lib/tdb.c \
            ../source3/lib/genrand.c \
            ../source3/lib/util_str.c \
            ../source3/lib/util_file.c \
            ../source3/lib/util_sock.c \
            ../source3/lib/util_net.c \
            ../source3/lib/util_str_hex.c \
            ../source3/lib/util_strlist.c \
            ../source3/lib/util_pw.c \
            ../source3/lib/util_crypt.c \
            ../source3/lib/util_sec.c \
            ../source3/lib/util_unistr.c \
            ../source3/lib/util_sid.c \
            ../source3/lib/util_nttoken.c \
            ../source3/lib/util_ntaccess.c \
            ../source3/lib/util_ace.c \
            ../source3/lib/util_sd.c \
            ../source3/lib/util_samlogon.c \
            ${LDFLAGS} \
            -I../source3/include -I../source3 -I../lib -I../include \
            -DHAVE_CONFIG_H -DPASSDB -DSHADOW -DQUOTA -DACL -DHAVE_MMAP -DHAVE_FCNTL_LOCK -DHAVE_KRB5 -DHAVE_ADS
          
          echo "ç¼–è¯‘smbpasswd..."
          ${CC} ${CFLAGS} -o smbpasswd \
            ../source3/utils/smbpasswd.c \
            ../source3/lib/util.c \
            ../source3/lib/charcnv.c \
            ../source3/lib/time.c \
            ../source3/lib/byteorder.c \
            ../source3/lib/md4.c \
            ../source3/lib/rc4.c \
            ../source3/lib/md5.c \
            ../source3/lib/hmacmd5.c \
            ../source3/lib/msrpc_parse.c \
            ../source3/lib/asn1.c \
            ../source3/lib/iconv.c \
            ../source3/lib/clique.c \
            ../source3/lib/access.c \
            ../source3/lib/deny.c \
            ../source3/lib/username.c \
            ../source3/lib/privileges.c \
            ../source3/lib/sec_ctx.c \
            ../source3/lib/security.c \
            ../source3/lib/session.c \
            ../source3/lib/smbrun.c \
            ../source3/lib/fsusage.c \
            ../source3/lib/statvfs.c \
            ../source3/lib/dprintf.c \
            ../source3/lib/xfile.c \
            ../source3/lib/wins_srv.c \
            ../source3/lib/namequery.c \
            ../source3/lib/nameresolve.c \
            ../source3/lib/substitute.c \
            ../source3/lib/fsusage.c \
            ../source3/lib/bitmap.c \
            ../source3/lib/pidfile.c \
            ../source3/lib/select.c \
            ../source3/lib/talloc.c \
            ../source3/lib/tdb.c \
            ../source3/lib/genrand.c \
            ../source3/lib/util_str.c \
            ../source3/lib/util_file.c \
            ../source3/lib/util_sock.c \
            ../source3/lib/util_net.c \
            ../source3/lib/util_str_hex.c \
            ../source3/lib/util_strlist.c \
            ../source3/lib/util_pw.c \
            ../source3/lib/util_crypt.c \
            ../source3/lib/util_sec.c \
            ../source3/lib/util_unistr.c \
            ../source3/lib/util_sid.c \
            ../source3/lib/util_nttoken.c \
            ../source3/lib/util_ntaccess.c \
            ../source3/lib/util_ace.c \
            ../source3/lib/util_sd.c \
            ../source3/lib/util_samlogon.c \
            ${LDFLAGS} \
            -I../source3/include -I../source3 -I../lib -I../include \
            -DHAVE_CONFIG_H -DPASSDB -DSHADOW -DQUOTA -DACL -DHAVE_MMAP -DHAVE_FCNTL_LOCK -DHAVE_KRB5 -DHAVE_ADS
          EOF
          
          chmod +x cross-compile-samba.sh
          ./cross-compile-samba.sh

      - name: Final attempt - use prebuilt binaries
        if: failure()
        run: |
          echo "===== æœ€ç»ˆå°è¯•: ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          # ç”±äºŽç¼–è¯‘å¤šæ¬¡å¤±è´¥ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä¸‹è½½é¢„ç¼–è¯‘çš„SambaäºŒè¿›åˆ¶æ–‡ä»¶
          mkdir -p samba-deploy
          cd samba-deploy
          
          # å°è¯•ä»Žå·²çŸ¥æ¥æºä¸‹è½½é¢„ç¼–è¯‘çš„ARMv7 SambaäºŒè¿›åˆ¶æ–‡ä»¶
          echo "å°è¯•ä¸‹è½½é¢„ç¼–è¯‘çš„Samba for ARMv7..."
          
          # è¿™é‡Œæ˜¯ä¸€äº›å¯èƒ½çš„æ¥æºï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®žé™…å¯ç”¨çš„é“¾æŽ¥ï¼‰
          wget -O smbd http://example.com/path/to/smbd-armv7 || echo "ä¸‹è½½smbdå¤±è´¥"
          wget -O nmbd http://example.com/path/to/nmbd-armv7 || echo "ä¸‹è½½nmbdå¤±è´¥"
          wget -O smbpasswd http://example.com/path/to/smbpasswd-armv7 || echo "ä¸‹è½½smbpasswdå¤±è´¥"
          
          # å¦‚æžœæ²¡æœ‰ä¸‹è½½åˆ°ï¼Œåˆ›å»ºå ä½ç¬¦æ–‡ä»¶
          if [ ! -f "smbd" ]; then
            echo "åˆ›å»ºå ä½ç¬¦smbdæ–‡ä»¶"
            echo "#!/bin/sh" > smbd
            echo "echo 'è¿™æ˜¯Samba smbdçš„å ä½ç¬¦æ–‡ä»¶'" >> smbd
            echo "echo 'å®žé™…ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç¼–è¯‘æˆ–å¯»æ‰¾é¢„ç¼–è¯‘ç‰ˆæœ¬'" >> smbd
            chmod +x smbd
          fi
          
          if [ ! -f "nmbd" ]; then
            echo "åˆ›å»ºå ä½ç¬¦nmbdæ–‡ä»¶"
            echo "#!/bin/sh" > nmbd
            echo "echo 'è¿™æ˜¯Samba nmbdçš„å ä½ç¬¦æ–‡ä»¶'" >> nmbd
            echo "echo 'å®žé™…ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç¼–è¯‘æˆ–å¯»æ‰¾é¢„ç¼–è¯‘ç‰ˆæœ¬'" >> nmbd
            chmod +x nmbd
          fi
          
          if [ ! -f "smbpasswd" ]; then
            echo "åˆ›å»ºå ä½ç¬¦smbpasswdæ–‡ä»¶"
            echo "#!/bin/sh" > smbpasswd
            echo "echo 'è¿™æ˜¯Samba smbpasswdçš„å ä½ç¬¦æ–‡ä»¶'" >> smbpasswd
            echo "echo 'å®žé™…ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç¼–è¯‘æˆ–å¯»æ‰¾é¢„ç¼–è¯‘ç‰ˆæœ¬'" >> smbpasswd
            chmod +x smbpasswd
          fi

      - name: Create installation instructions
        run: |
          echo "===== åˆ›å»ºå®‰è£…è¯´æ˜Ž ====="
          mkdir -p samba-deploy
          cd samba-deploy
          
          # åˆ›å»ºè¯¦ç»†çš„å®‰è£…è¯´æ˜Ž
          cat > INSTALL.md << 'EOF'
          # Samba for ARMv7 å®‰è£…è¯´æ˜Ž
          
          ç”±äºŽè‡ªåŠ¨ç¼–è¯‘è¿‡ç¨‹é‡åˆ°å›°éš¾ï¼Œè¿™é‡Œæä¾›å‡ ç§æ›¿ä»£æ–¹æ¡ˆï¼š
          
          ## æ–¹æ¡ˆä¸€: ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶
          1. ä»Žå¯é æ¥æºä¸‹è½½ARMv7æž¶æž„çš„SambaäºŒè¿›åˆ¶æ–‡ä»¶
          2. å°†smbdã€nmbdå’Œsmbpasswdå¤åˆ¶åˆ°/usr/sbin/
          3. è®¾ç½®æ‰§è¡Œæƒé™: chmod +x /usr/sbin/smbd /usr/sbin/nmbd /usr/sbin/smbpasswd
          
          ## æ–¹æ¡ˆäºŒ: åœ¨ç›®æ ‡è®¾å¤‡ä¸Šç›´æŽ¥ç¼–è¯‘
          1. åœ¨ARMè®¾å¤‡ä¸Šä¸‹è½½Sambaæºç : wget https://download.samba.org/pub/samba/stable/samba-4.5.16.tar.gz
          2. è§£åŽ‹: tar -xzf samba-4.5.16.tar.gz
          3. è¿›å…¥ç›®å½•: cd samba-4.5.16/source3
          4. é…ç½®: ./configure --prefix=/usr
          5. ç¼–è¯‘: make smbd nmbd smbpasswd
          6. å®‰è£…: make install
          
          ## æ–¹æ¡ˆä¸‰: ä½¿ç”¨åŒ…ç®¡ç†å™¨
          å¦‚æžœæ‚¨çš„ç³»ç»Ÿæœ‰åŒ…ç®¡ç†å™¨ï¼Œå¯ä»¥å°è¯•:
          - apt-get install samba (Debian/Ubuntu)
          - opkg install samba (OpenWrt)
          - yum install samba (CentOS/RHEL)
          
          ## é…ç½®Samba
          å®‰è£…åŽï¼Œéœ€è¦åˆ›å»ºé…ç½®æ–‡ä»¶/etc/samba/smb.conf:
          
          [global]
          workgroup = WORKGROUP
          server string = Samba Server
          security = user
          map to guest = Bad User
          
          [shared]
          comment = Shared Folder
          path = /mnt/shared
          browseable = yes
          writable = yes
          guest ok = no
          EOF
          
          # åˆ›å»ºç®€å•çš„å®‰è£…è„šæœ¬
          cat > install.sh << 'EOF'
          #!/bin/sh
          echo "Samba for ARMv7 å®‰è£…åŠ©æ‰‹"
          echo ""
          echo "ç”±äºŽè‡ªåŠ¨ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å®‰è£…Samba:"
          echo "1. æŸ¥çœ‹INSTALL.mdæ–‡ä»¶èŽ·å–è¯¦ç»†è¯´æ˜Ž"
          echo "2. æˆ–ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…: apt-get install samba"
          echo "3. æˆ–ä»Žå¯é æ¥æºä¸‹è½½é¢„ç¼–è¯‘çš„ARMv7 SambaäºŒè¿›åˆ¶æ–‡ä»¶"
          echo ""
          echo "å¦‚æžœæ‚¨æœ‰ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥å¤åˆ¶åˆ°å½“å‰ç›®å½•å¹¶é‡æ–°è¿è¡Œæ­¤è„šæœ¬"
          
          if [ -f "smbd" ] && [ -f "nmbd" ] && [ -f "smbpasswd" ]; then
            echo "æ£€æµ‹åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°è¯•å®‰è£…..."
            sudo cp smbd nmbd smbpasswd /usr/sbin/
            sudo chmod +x /usr/sbin/smbd /usr/sbin/nmbd /usr/sbin/smbpasswd
            echo "å®‰è£…å®Œæˆ!"
          else
            echo "æœªæ‰¾åˆ°æœ‰æ•ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶"
          fi
          EOF
          
          chmod +x install.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba-armv7-alternatives
          path: |
            samba-deploy/INSTALL.md
            samba-deploy/install.sh
            samba-deploy/smbd
            samba-deploy/nmbd
            samba-deploy/smbpasswd
          retention-days: 30

      - name: Show final message
        run: |
          echo "âš ï¸  Sambaç¼–è¯‘é‡åˆ°å›°éš¾"
          echo "ðŸ“‹ å·²ä¸Šä¼ æ›¿ä»£æ–¹æ¡ˆå’Œå®‰è£…è¯´æ˜Ž"
          echo "ðŸ’¡ å»ºè®®:"
          echo "   1. åœ¨ç›®æ ‡è®¾å¤‡ä¸Šç›´æŽ¥ç¼–è¯‘Samba"
          echo "   2. ä½¿ç”¨ç³»ç»ŸåŒ…ç®¡ç†å™¨å®‰è£…Samba"
          echo "   3. å¯»æ‰¾é¢„ç¼–è¯‘çš„ARMv7 SambaäºŒè¿›åˆ¶æ–‡ä»¶"
          echo "ðŸ”— å‚è€ƒ: https://www.samba.org/samba/download/"
