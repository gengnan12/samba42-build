name: Build Samba for ARMv5

on:
  workflow_dispatch: # 允许手动触发工作流
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  SAMBA_VERSION: "4.19.3" # 建议使用最新的稳定版，请从 samba.org 获取

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies and cross-toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          wget \
          pkg-config \
          python3 \
          libacl1-dev \
          libattr1-dev \
          libblkid-dev \
          libgnutls28-dev \
          libreadline-dev \
          gcc-arm-linux-gnueabi \
          g++-arm-linux-gnueabi

    - name: Download Samba source
      run: |
        wget https://download.samba.org/pub/samba/stable/samba-$SAMBA_VERSION.tar.gz
        tar -xzf samba-$SAMBA_VERSION.tar.gz
        cd samba-$SAMBA_VERSION

    - name: Configure Samba for ARMv5
      run: |
        cd samba-$SAMBA_VERSION
        CC=arm-linux-gnueabi-gcc ./configure \
          --prefix=/usr \
          --host=arm-linux-gnueabi \
          --enable-cross-answers=yes \
          --disable-avahi \
          --disable-cups \
          --disable-pie \
          --without-ad-dc \
          --without-ldap \
          --without-ads \
          --without-systemd \
          --with-shared-modules=!vfs_snapper

        # 注意：这是一个最小化配置，移除了很多大型依赖。
        # 你可以根据你的设备需求，使用 `./configure --help` 查看选项来增删模块。

    - name: Build Samba (This will take a while...)
      run: |
        cd samba-$SAMBA_VERSION
        make -j$(nproc) # 使用所有可用的CPU核心进行编译

    - name: Package the binaries
      run: |
        mkdir -p samba-armv5-binaries/bin
        mkdir -p samba-armv5-binaries/sbin
        mkdir -p samba-armv5-binaries/lib
        # 复制关键二进制文件和库
        cp samba-$SAMBA_VERSION/bin/* samba-armv5-binaries/bin/ || true
        cp samba-$SAMBA_VERSION/sbin/* samba-armv5-binaries/sbin/ || true
        # 使用 find 命令查找并复制 .so 文件，可能需要根据你的需求调整
        find samba-$SAMBA_VERSION/bin -name "*.so" -exec cp {} samba-armv5-binaries/lib/ \; || true
        # 创建一个简单的版本信息文件
        echo "Samba $SAMBA_VERSION built for ARMv5 on $(date)" > samba-armv5-binaries/INFO.txt

    - name: Upload binaries as artifact
      uses: actions/upload-artifact@v4
      with:
        name: samba-armv5-binaries
        path: samba-armv5-binaries/
        retention-days: 5
