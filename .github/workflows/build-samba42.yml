name: Build Samba 4 for ARMv7 (Waf Build System)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install basic tools
        run: |
          echo "===== å®‰è£…åŸºç¡€å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            pkg-config \
            curl \
            python3 \
            python3-pip \
            xsltproc \
            docbook-xsl

      - name: Download and build Samba with Waf
        run: |
          echo "===== ä½¿ç”¨Wafæž„å»ºç³»ç»Ÿç¼–è¯‘Samba ====="
          # ä¸‹è½½Sambaç‰ˆæœ¬
          SAMBA_VERSION="4.18.0"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz
          cd samba-${SAMBA_VERSION}

          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export AR="arm-linux-gnueabihf-ar"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -ffunction-sections -fdata-sections"
          export LDFLAGS="-static -Wl,--gc-sections"

          # ä½¿ç”¨waf configureï¼ˆæ­£ç¡®çš„è¯­æ³•ï¼‰
          ./configure \
            --cross-compile \
            --cross-answers=arm.txt \
            --host=arm-linux-gnueabihf \
            --target=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --disable-avahi \
            --disable-cups \
            --disable-iprint \
            --disable-glusterfs \
            --disable-rpath \
            --disable-fault-handling \
            --nonshared-binary=smbd,nmbd,smbpasswd

          # ç¼–è¯‘ç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶
          ./buildtools/bin/waf build --targets=smbd,nmbd,smbpasswd

          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          mkdir -p ../samba-deploy
          cp bin/smbd bin/nmbd bin/smbpasswd ../samba-deploy/

      - name: Alternative simple build
        if: failure()
        run: |
          echo "===== ç®€å•ç¼–è¯‘æ–¹æ¡ˆ ====="
          SAMBA_VERSION="4.18.0"
          cd samba-${SAMBA_VERSION}

          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"

          # ç›´æŽ¥ä½¿ç”¨makeï¼ˆå¦‚æžœå¯ç”¨ï¼‰
          if [ -f "Makefile" ]; then
            make -j$(nproc) \
              CC="${CC}" \
              CFLAGS="${CFLAGS}" \
              LDFLAGS="${LDFLAGS}" \
              smbd nmbd smbpasswd
          else
            # ä½¿ç”¨wafç›´æŽ¥æž„å»º
            ./buildtools/bin/waf build --targets=smbd,nmbd,smbpasswd \
              --cross-compile \
              --host=arm-linux-gnueabihf \
              --cflags="${CFLAGS}" \
              --ldflags="${LDFLAGS}"
          fi

          mkdir -p ../samba-deploy
          cp bin/smbd bin/nmbd bin/smbpasswd ../samba-deploy/

      - name: Build minimal from source3
        if: failure()
        run: |
          echo "===== ä»Žsource3æœ€å°åŒ–ç¼–è¯‘ ====="
          # å°è¯•æ—§ç‰ˆæœ¬
          SAMBA_VERSION="4.8.12"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz
          cd samba-${SAMBA_VERSION}/source3

          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"

          # å°è¯•autoconfæ–¹å¼
          if [ -f "configure" ]; then
            ./configure \
              --host=arm-linux-gnueabihf \
              --prefix=/usr \
              --enable-static-binaries
          elif [ -f "autogen.sh" ]; then
            ./autogen.sh
            ./configure \
              --host=arm-linux-gnueabihf \
              --prefix=/usr
          fi

          # ç¼–è¯‘æ ¸å¿ƒç»„ä»¶
          make -j$(nproc) \
            CC="${CC}" \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            smbd nmbd smbpasswd

          mkdir -p ../../samba-deploy
          cp bin/smbd bin/nmbd bin/smbpasswd ../../samba-deploy/

      - name: Verify and package binaries
        run: |
          echo "===== éªŒè¯å’Œæ‰“åŒ…äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          mkdir -p samba-deploy
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f "samba-4.18.0/bin/smbd" ]; then
            cp samba-4.18.0/bin/smbd samba-4.18.0/bin/nmbd samba-4.18.0/bin/smbpasswd samba-deploy/
          elif [ -f "samba-4.8.12/source3/bin/smbd" ]; then
            cp samba-4.8.12/source3/bin/smbd samba-4.8.12/source3/bin/nmbd samba-4.8.12/source3/bin/smbpasswd samba-deploy/
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi

          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          cd samba-deploy
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file smbd
          echo "æž¶æž„æ£€æŸ¥:"
          arm-linux-gnueabihf-readelf -h smbd | grep "Machine:" | grep "ARM" || exit 1
          echo "é“¾æŽ¥ç±»åž‹:"
          arm-linux-gnueabihf-readelf -d smbd | grep "Shared library" || echo "é™æ€é“¾æŽ¥"

      - name: Create installation package
        run: |
          echo "===== åˆ›å»ºå®‰è£…åŒ… ====="
          cd samba-deploy
          
          cat > install.sh << 'EOF'
          #!/bin/sh
          echo "=== Samba ARMv7 å®‰è£…ç¨‹åº ==="
          echo ""
          
          # æ£€æŸ¥rootæƒé™
          if [ "$(id -u)" -ne 0 ]; then
            echo "è¯·ä½¿ç”¨rootæƒé™è¿è¡Œæ­¤è„šæœ¬"
            echo "sudo ./install.sh"
            exit 1
          fi
          
          echo "å®‰è£…SambaäºŒè¿›åˆ¶æ–‡ä»¶..."
          echo ""
          
          # å®‰è£…æ¯ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
          for binfile in smbd nmbd smbpasswd; do
            if [ ! -f "$binfile" ]; then
              echo "é”™è¯¯: æ‰¾ä¸åˆ°æ–‡ä»¶ $binfile"
              continue
            fi
            
            # å¤‡ä»½åŽŸæœ‰æ–‡ä»¶
            if [ -f "/usr/sbin/$binfile" ]; then
              backup_file="/usr/sbin/${binfile}.backup.$(date +%Y%m%d_%H%M%S)"
              mv "/usr/sbin/$binfile" "$backup_file"
              echo "å·²å¤‡ä»½: $backup_file"
            fi
            
            # å®‰è£…æ–°æ–‡ä»¶
            install -m 755 "$binfile" "/usr/sbin/"
            echo "å·²å®‰è£…: /usr/sbin/$binfile"
          done
          
          echo ""
          echo "=== å®‰è£…å®Œæˆ ==="
          echo ""
          echo "ä¸‹ä¸€æ­¥:"
          echo "1. åˆ›å»ºé…ç½®æ–‡ä»¶: /etc/samba/smb.conf"
          echo "2. å¯åŠ¨æœåŠ¡: smbd -D && nmbd -D"
          echo "3. æ·»åŠ ç”¨æˆ·: smbpasswd -a ç”¨æˆ·å"
          echo ""
          echo "æŸ¥çœ‹ç¤ºä¾‹é…ç½®: cat smb.conf.example"
          EOF
          
          chmod +x install.sh
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶ç¤ºä¾‹
          cat > smb.conf.example << 'EOF'
          [global]
          workgroup = WORKGROUP
          netbios name = SAMBA_SERVER
          server string = Samba Server
          security = user
          map to guest = Bad User
          log file = /var/log/samba/log.%m
          max log size = 50
          socket options = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192

          [homes]
          comment = Home Directories
          browseable = no
          writable = yes
          valid users = %S

          [shared]
          comment = Shared Folder
          path = /mnt/shared
          browseable = yes
          writable = yes
          guest ok = no
          create mask = 0644
          directory mask = 0755
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba-armv7-binaries
          path: samba-deploy/*
          retention-days: 30

      - name: Show build success
        run: |
          echo "âœ… æž„å»ºæˆåŠŸ!"
          echo "ðŸ“¦ äºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          echo "ðŸ–¥ï¸  æž¶æž„: ARMv7"
          echo "ðŸ”§ ä½¿ç”¨Wafæž„å»ºç³»ç»Ÿ"
          echo "â° æ—¶é—´: $(date)"
