name: Build Samba 4 for ARMv7 (Fixed Build System)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install basic tools
        run: |
          echo "===== å®‰è£…åŸºç¡€å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            pkg-config \
            curl \
            python3 \
            python3-pip

      - name: Install Python dependencies for newer Samba
        run: |
          echo "===== å®‰è£…Pythonä¾èµ– ====="
          pip3 install --user setuptools

      - name: Build Samba 4.18+ (modern build system)
        run: |
          echo "===== ç¼–è¯‘çŽ°ä»£ç‰ˆSamba (4.18+) ====="
          # ä¸‹è½½è¾ƒæ–°çš„Sambaç‰ˆæœ¬ï¼Œæ”¯æŒçŽ°ä»£æž„å»ºç³»ç»Ÿ
          SAMBA_VERSION="4.18.0"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz
          cd samba-${SAMBA_VERSION}

          # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export AR="arm-linux-gnueabihf-ar"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"

          # ä½¿ç”¨bootstrapå’Œconfigure
          ./configure \
            --host=arm-linux-gnueabihf \
            --target=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --enable-static \
            --disable-shared \
            --without-gnutls \
            --with-builtin-libraries=md5,des,sha256,sha512,arc4

          # åªç¼–è¯‘æ ¸å¿ƒç»„ä»¶
          make -j$(nproc) all

          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          mkdir -p ../samba-deploy
          cp bin/smbd bin/nmbd bin/smbpasswd ../samba-deploy/

      - name: Alternative minimal build
        if: failure()
        run: |
          echo "===== æœ€å°åŒ–ç¼–è¯‘æ–¹æ¡ˆ ====="
          # å¦‚æžœæ ‡å‡†æž„å»ºå¤±è´¥ï¼Œå°è¯•æœ€å°åŒ–æž„å»º
          SAMBA_VERSION="4.18.0"
          cd samba-${SAMBA_VERSION}

          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"

          # ç›´æŽ¥ä½¿ç”¨makeç¼–è¯‘ç‰¹å®šç›®æ ‡
          make -j$(nproc) \
            CC="${CC}" \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            smbd nmbd smbpasswd

          mkdir -p ../samba-deploy
          cp bin/smbd bin/nmbd bin/smbpasswd ../samba-deploy/

      - name: Build from source3 directory (old style)
        if: failure()
        run: |
          echo "===== ä¼ ç»Ÿæ–¹å¼ç¼–è¯‘ ====="
          # å°è¯•ä½¿ç”¨source3ç›®å½•çš„ä¼ ç»Ÿæž„å»ºæ–¹å¼
          SAMBA_VERSION="4.8.12"
          wget https://download.samba.org/pub/samba/stable/samba-${SAMBA_VERSION}.tar.gz
          tar -xzf samba-${SAMBA_VERSION}.tar.gz
          cd samba-${SAMBA_VERSION}

          # è¿›å…¥source3ç›®å½•
          cd source3

          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os"
          export LDFLAGS="-static"

          # å¦‚æžœå­˜åœ¨autogen.shï¼Œå…ˆè¿è¡Œå®ƒ
          if [ -f "autogen.sh" ]; then
            ./autogen.sh
          fi

          # å¦‚æžœå­˜åœ¨configureè„šæœ¬ï¼Œä½¿ç”¨å®ƒ
          if [ -f "configure" ]; then
            ./configure \
              --host=arm-linux-gnueabihf \
              --prefix=/usr \
              --enable-static \
              --disable-shared
          fi

          # ç¼–è¯‘æ ¸å¿ƒç»„ä»¶
          make -j$(nproc) \
            CC="${CC}" \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            smbd nmbd smbpasswd

          mkdir -p ../../samba-deploy
          cp bin/smbd bin/nmbd bin/smbpasswd ../../samba-deploy/

      - name: Verify binaries
        run: |
          echo "===== éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          mkdir -p samba-deploy
          
          # æ£€æŸ¥å¹¶å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f "samba-4.18.0/bin/smbd" ]; then
            cp samba-4.18.0/bin/smbd samba-4.18.0/bin/nmbd samba-4.18.0/bin/smbpasswd samba-deploy/
          elif [ -f "samba-4.8.12/source3/bin/smbd" ]; then
            cp samba-4.8.12/source3/bin/smbd samba-4.8.12/source3/bin/nmbd samba-4.8.12/source3/bin/smbpasswd samba-deploy/
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi

          cd samba-deploy
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file smbd
          echo "æž¶æž„æ£€æŸ¥:"
          arm-linux-gnueabihf-readelf -h smbd | grep "Machine:" | grep "ARM" || exit 1

      - name: Create installation package
        run: |
          echo "===== åˆ›å»ºå®‰è£…åŒ… ====="
          cd samba-deploy
          
          cat > install.sh << 'EOF'
          #!/bin/sh
          echo "=== Samba for ARMv7 å®‰è£…ç¨‹åº ==="
          echo "ç³»ç»Ÿä¿¡æ¯: $(uname -a)"
          
          # æ£€æŸ¥æž¶æž„
          if [ "$(uname -m)" != "armv7l" ]; then
            echo "è­¦å‘Š: å½“å‰æž¶æž„æ˜¯ $(uname -m)ï¼Œä½†äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ä¸ºARMv7ç¼–è¯‘çš„"
            read -p "æ˜¯å¦ç»§ç»­å®‰è£…? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
              exit 1
            fi
          fi
          
          # å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
          for bin in smbd nmbd smbpasswd; do
            if [ -f "$bin" ]; then
              if [ -f "/usr/sbin/$bin" ]; then
                mv "/usr/sbin/$bin" "/usr/sbin/${bin}.backup"
                echo "å·²å¤‡ä»½åŽŸæ–‡ä»¶: /usr/sbin/${bin}.backup"
              fi
              install -m 755 "$bin" "/usr/sbin/"
              echo "å·²å®‰è£…: /usr/sbin/$bin"
            else
              echo "é”™è¯¯: æ‰¾ä¸åˆ°æ–‡ä»¶ $bin"
            fi
          done
          
          echo ""
          echo "=== å®‰è£…å®Œæˆ ==="
          echo ""
          echo "ä½¿ç”¨æ–¹æ³•:"
          echo "1. å¯åŠ¨æ–‡ä»¶å…±äº«æœåŠ¡: smbd -D"
          echo "2. å¯åŠ¨åç§°è§£æžæœåŠ¡: nmbd -D"
          echo "3. æ·»åŠ ç”¨æˆ·: smbpasswd -a ç”¨æˆ·å"
          echo ""
          echo "éœ€è¦å…ˆåˆ›å»ºé…ç½®æ–‡ä»¶ /etc/samba/smb.conf"
          EOF
          
          chmod +x install.sh
          
          # åˆ›å»ºç®€å•çš„é…ç½®æ–‡ä»¶ç¤ºä¾‹
          cat > smb.conf.example << 'EOF'
          [global]
          workgroup = WORKGROUP
          server string = Samba Server
          security = user
          map to guest = Bad User
          log file = /var/log/samba/log.%m
          max log size = 50

          [shared]
          comment = Shared Folder
          path = /mnt/shared
          browseable = yes
          writable = yes
          valid users = @smbusers
          create mask = 0664
          directory mask = 0775
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba-armv7-binaries
          path: samba-deploy/*
          retention-days: 30

      - name: Show build success
        run: |
          echo "âœ… æž„å»ºæˆåŠŸ!"
          echo "ðŸ“¦ äºŒè¿›åˆ¶æ–‡ä»¶å·²ä¸Šä¼ åˆ°Artifacts"
          echo "ðŸ–¥ï¸  æž¶æž„: ARMv7"
          echo "ðŸ”§ ä½¿ç”¨çŽ°ä»£æž„å»ºç³»ç»Ÿ"
          echo "â° æ—¶é—´: $(date)"
