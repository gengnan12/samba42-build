name: Build Samba 4 for ARMv7 (Simplified)

on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install basic tools
        run: |
          echo "===== å®‰è£…åŸºç¡€å·¥å…· ====="
          sudo apt update
          sudo apt install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            wget tar xz-utils make \
            python3 python3-dev \
            pkg-config \
            curl

      - name: Build zlib from source
        run: |
          echo "===== ç¼–è¯‘zlib ====="
          wget https://zlib.net/zlib-1.2.13.tar.gz || \
          wget https://github.com/madler/zlib/releases/download/v1.2.13/zlib-1.2.13.tar.gz
          
          tar -xzf zlib-1.2.13.tar.gz
          cd zlib-1.2.13
          
          CC="arm-linux-gnueabihf-gcc" \
          CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS" \
          ./configure --prefix=/opt/arm-deps --static
          
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Build OpenSSL from source
        run: |
          echo "===== ç¼–è¯‘OpenSSL ====="
          wget https://www.openssl.org/source/openssl-1.1.1w.tar.gz || \
          wget https://github.com/openssl/openssl/releases/download/OpenSSL_1_1_1w/openssl-1.1.1w.tar.gz
          
          tar -xzf openssl-1.1.1w.tar.gz
          cd openssl-1.1.1w
          
          export CROSS_COMPILE="arm-linux-gnueabihf-"
          export CC="${CROSS_COMPILE}gcc"
          export AR="${CROSS_COMPILE}ar"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS"
          
          ./Configure linux-armv4 \
            --prefix=/opt/arm-deps \
            no-shared \
            no-dso \
            no-asm \
            no-tests \
            ${CFLAGS}
          
          sed -i 's/^CC=.*/CC=$(CROSS_COMPILE)gcc/' Makefile
          sed -i 's/^AR=.*/AR=$(CROSS_COMPILE)ar/' Makefile
          
          make -j$(nproc)
          sudo make install
          cd ..

      - name: Download and compile Samba 4.8 (with built-in crypto)
        run: |
          echo "===== ä¸‹è½½å’Œç¼–è¯‘Samba (ä½¿ç”¨å†…ç½®åŠ å¯†) ====="
          wget https://download.samba.org/pub/samba/stable/samba-4.8.12.tar.gz || \
          wget https://download.samba.org/pub/samba/old/4.8.12/samba-4.8.12.tar.gz
          
          tar -xzf samba-4.8.12.tar.gz
          cd samba-4.8.12

          export CC="arm-linux-gnueabihf-gcc"
          export CXX="arm-linux-gnueabihf-g++"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static -lssl -lcrypto -lz"

          # é…ç½®Sambaä½¿ç”¨å†…ç½®åŠ å¯†ï¼Œé¿å…å¤æ‚çš„GnuTLSä¾èµ–
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --without-systemd \
            --without-winbind \
            --with-zlib=/opt/arm-deps \
            --enable-static \
            --disable-shared \
            --without-acl-support \
            --without-ads \
            --without-pam \
            --without-gnutls \
            --with-builtin-libraries=md5,des,sha256,sha512,arc4 \
            --with-shared-modules=idmap_nss,idmap_rid,idmap_ad,idmap_adex,idmap_hash,idmap_tdb2 \
            ac_cv_func_fstatfs=yes \
            ac_cv_lib_crypto_EVP_MD_CTX_new=yes

          # åªç¼–è¯‘å¿…è¦çš„ç»„ä»¶
          make -j$(nproc) all

      - name: Alternative approach if above fails
        if: failure()
        run: |
          echo "===== ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ: åªç¼–è¯‘æ ¸å¿ƒç»„ä»¶ ====="
          cd samba-4.8.12
          
          # ç›´æŽ¥ç¼–è¯‘æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè·³è¿‡å¤æ‚çš„é…ç½®
          export CC="arm-linux-gnueabihf-gcc"
          export CFLAGS="-march=armv7-a -mfpu=neon -Os -U_TIME_BITS -U_FILE_OFFSET_BITS -I/opt/arm-deps/include"
          export LDFLAGS="-L/opt/arm-deps/lib -static -lssl -lcrypto -lz"
          
          # ç¼–è¯‘smbd
          cd source3
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --enable-static \
            --disable-shared \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}"
          
          make -j$(nproc) smbd nmbd smbpasswd

      - name: Verify and collect binaries
        run: |
          echo "===== éªŒè¯å’Œæ”¶é›†äºŒè¿›åˆ¶æ–‡ä»¶ ====="
          mkdir -p samba-deploy
          
          # æŸ¥æ‰¾ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -f "samba-4.8.12/bin/smbd" ]; then
            cp samba-4.8.12/bin/smbd samba-4.8.12/bin/nmbd samba-4.8.12/bin/smbpasswd samba-deploy/
          elif [ -f "samba-4.8.12/source3/bin/smbd" ]; then
            cp samba-4.8.12/source3/bin/smbd samba-4.8.12/source3/bin/nmbd samba-4.8.12/source3/bin/smbpasswd samba-deploy/
          else
            echo "é”™è¯¯: æ‰¾ä¸åˆ°ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶"
            exit 1
          fi
          
          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          cd samba-deploy
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file smbd
          file nmbd
          file smbpasswd
          
          echo "æž¶æž„æ£€æŸ¥:"
          arm-linux-gnueabihf-readelf -h smbd | grep "Machine:" | grep "ARM" || exit 1

      - name: Create minimal deployment package
        run: |
          echo "===== åˆ›å»ºæœ€å°éƒ¨ç½²åŒ… ====="
          cd samba-deploy
          
          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > install.sh << 'EOF'
          #!/bin/sh
          echo "å®‰è£…Samba for ARMv7..."
          echo "ç³»ç»Ÿæž¶æž„: $(uname -m)"
          
          # æ£€æŸ¥æž¶æž„æ˜¯å¦åŒ¹é…
          if [ "$(uname -m)" != "armv7l" ] && [ "$(uname -m)" != "armv7" ]; then
            echo "è­¦å‘Š: å½“å‰æž¶æž„æ˜¯ $(uname -m)ï¼Œä½†äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯ä¸ºARMv7ç¼–è¯‘çš„"
            read -p "ç»§ç»­å®‰è£…? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
              exit 1
            fi
          fi
          
          # å®‰è£…æ–‡ä»¶
          for bin in smbd nmbd smbpasswd; do
            if [ -f "/usr/sbin/$bin" ]; then
              mv "/usr/sbin/$bin" "/usr/sbin/${bin}.backup"
              echo "å·²å¤‡ä»½: /usr/sbin/${bin}.backup"
            fi
            install -m 755 "$bin" "/usr/sbin/"
            echo "å·²å®‰è£…: /usr/sbin/$bin"
          done
          
          echo "å®‰è£…å®Œæˆ!"
          echo ""
          echo "ä½¿ç”¨æ–¹æ³•:"
          echo "å¯åŠ¨æ–‡ä»¶å…±äº«: smbd -D"
          echo "å¯åŠ¨åç§°æœåŠ¡: nmbd -D" 
          echo "æ·»åŠ ç”¨æˆ·: smbpasswd -a ç”¨æˆ·å"
          EOF
          
          chmod +x install.sh
          
          # åˆ›å»ºç®€å•çš„é…ç½®æ–‡ä»¶
          cat > smb.conf.example << 'EOF'
          [global]
          workgroup = WORKGROUP
          server string = Samba Server
          security = user
          map to guest = Bad User
          log file = /var/log/samba/log.%m
          max log size = 50

          [shared]
          comment = Shared Folder
          path = /mnt/shared
          browseable = yes
          writable = yes
          guest ok = no
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: samba4.8-armv7-minimal
          path: samba-deploy/*
          retention-days: 30

      - name: Show build success
        run: |
          echo "âœ… æž„å»ºæˆåŠŸ!"
          echo "ðŸ“¦ åŒ…å«: smbd, nmbd, smbpasswd"
          echo "ðŸ–¥ï¸  æž¶æž„: ARMv7"
          echo "ðŸ”’ åŠ å¯†: OpenSSL + å†…ç½®ç®—æ³•"
          echo "â° æ—¶é—´: $(date)"
